<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html style="width:100%;height:100%">
<head>
    <title></title>
    <link href="easyui/css/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <link href="easyui/css/themes/icon.css" rel="stylesheet" type="text/css" />
    <link href="easyui/css/demo.css" rel="stylesheet" type="text/css" />
    <link href="easyui/css/dlg.css" rel="stylesheet" type="text/css" />
    <script src="easyui/js/jquery-1.8.2.min.js" type="text/javascript"></script>
    <script src="easyui/js/jquery.easyui.min.js" type="text/javascript"></script>
     <script src="easyui/js/easyui-lang-zh_CN.js" type="text/javascript"></script>

    <script src="common.js" type="text/javascript"></script>

    <script type="text/javascript">
        //查询
        function searchVal() {
            var qsrq = $('#dqsrq').datebox('getValue');
            var jzrq = $('#djzrq').datebox('getValue');

            var ckey = $('#sel_key').combobox('getValue');
            var cmemo = $('#cmemo').val();

            $('#tab').datagrid({ url: 'tjjl.ashx', queryParams: { "action": "query", qsrq: qsrq, jzrq: jzrq, ckey: ckey, cmemo: cmemo, state: "s"} });
        }


        //高级查询
        function search_dg() {
            //表单清空
            //不能使用表单清空，原因是该语句生效后，还能获取上次表单留下的内容，与查询条件不符，所以该语句注释掉
            //$("#fm_search")[0].reset();       

            //显示
            $("#div_search").show();

            //以窗体的形式展示
            $("#div_search").dialog({
                title: "高级查询", //标题
                iconCls: "icon-search", //图标
                width: 600, //窗体的宽度
                height: 350, //窗体的高度
                modal: true, //遮罩层
                //按钮集合
                buttons: [
            {
                text: "确定", //添加按钮的文本值
                iconCls: "icon-ok", //添加按钮的图标
                handler: function () {
                    //将数据序列化
                    var parm = $("#fm_search").serialize();
                    //中文格式转换
                    var pp = decodeURIComponent(parm, true);

                    $("#tab_device").treegrid('load', { "action": "search", data: pp });

                    $("#div_search").window("close");
                }
            },
              {
                  text: "取消",
                  iconCls: "icon-cancel",
                  handler: function () {
                      $("#div_search").window("close");
                  }
              }
            ]
            });
        }

        //选择设备
        function selectDevice() {
            //表单清空
            $("#form2")[0].reset();
            //显示
            $("#div2").show();
            //以窗体的形式展示
            $("#div2").dialog({
                title: "选择设备", //标题
                iconCls: "icon-ok", //图标
                width: 850, //窗体的宽度
                height: 500, //窗体的高度
                modal: true, //遮罩层
                //按钮集合
                buttons: [
            {
                text: "确定", //添加按钮的文本值
                iconCls: "icon-ok", //添加按钮的图标
                handler: function () {
                    //获取选定行
                    var selected = $('#tab_device').treegrid('getSelected');

                    if (selected != null) {
                        $("#csbbh").val(selected.csbbh);
                        $("#csbmc").val(selected.csbmc);
                        $("#cscx").val(selected.cscx);
                        $("#czy").val(selected.csszy);
                    }

                    $("#div2").window("close");
                }
            },
              {
                  text: "取消",
                  iconCls: "icon-cancel",
                  handler: function () {
                      $("#div2").window("close");
                  }
              }
            ]
            });
      }

      //选择员工
      function selectPerson() {
          //表单清空
          $("#form4")[0].reset();
          //显示
          $("#div4").show();
          //以窗体的形式展示
          $("#div4").dialog({
              title: "选择员工", //标题
              iconCls: "icon-ok", //图标
              width: 850, //窗体的宽度
              height: 500, //窗体的高度
              modal: true, //遮罩层
              //按钮集合
              buttons: [
            {
                text: "确定", //添加按钮的文本值
                iconCls: "icon-ok", //添加按钮的图标
                handler: function () {
                    //获取选定行
                    var selected = $('#tab_person').datagrid('getSelected');

                    if (selected != null) {
                        $("#ctjr").val(selected.JSON_cygbh + "-" + selected.JSON_cygxm);
                    }

                    $("#div4").window("close");
                }
            },
              {
                  text: "取消",
                  iconCls: "icon-cancel",
                  handler: function () {
                      $("#div4").window("close");
                  }
              }
            ]
          });
      }

      //选择员工
      function selPerson() {
          //表单清空
          $("#form5")[0].reset();
          //显示
          $("#div5").show();
          //以窗体的形式展示
          $("#div5").dialog({
              title: "选择员工", //标题
              iconCls: "icon-ok", //图标
              width: 850, //窗体的宽度
              height: 500, //窗体的高度
              modal: true, //遮罩层
              //按钮集合
              buttons: [
            {
                text: "确定", //添加按钮的文本值
                iconCls: "icon-ok", //添加按钮的图标
                handler: function () {
                    //获取所有选定行
                    var selected = $('#tab_per').datagrid('getSelections');
                    var parms = "";

                    if (selected != null) {
                        for (var i = 0; i < selected.length; i++) {

                            parms = parms + "," + selected[i].JSON_cygbh + "-" + selected[i].JSON_cygxm;
                        }

                        $("#cfzry").val(parms.substring(1, parms.length));
                    }

                    $("#div5").window("close");
                }
            },
              {
                  text: "取消",
                  iconCls: "icon-cancel",
                  handler: function () {
                      $("#div5").window("close");
                  }
              }
            ]
          });
      }

      $(function () {
//          var myDate = new Date();
//          //使用服务器函数返回日期
//          $.post("getDate.ashx", { data: myDate.toLocaleDateString() }, function (data) {
//              $('#dqsrq').datebox('setValue', data);
//              $('#djzrq').datebox('setValue', data);
          //          });

          $('#dqsrq').datebox('setValue', getCurDate());
          $('#djzrq').datebox('setValue', getCurDate());

            $('#ctjzl').combotree({
                url: 'tjzl.ashx',
                method: 'get',
                valueField: 'id',
                textField: 'text',
                panelWidth: 300,
                panelHeight: 'auto',
                editable: false
            });

//            $('#ctjr').combobox({
//                url: 'ygzl_load.ashx?action=1',
//                method: 'get',
//                valueField: 'text',
//                textField: 'text',
//                panelWidth: 350,
//                panelHeight: 'auto',
//                editable: false
//            });

            $('#s_csbfl').combotree({
                url: 'sbfl.ashx',     //显示最末级分类
                method: 'get',
                valueField: 'id',
                textField: 'text',
                editable: true
            });


            $('#s_csbdj').combobox({
                url: 'common.ashx?action=2',
                method: 'get',
                valueField: 'text',
                textField: 'text',
                panelWidth: 350,
                panelHeight: 'auto',
                editable: true
            });

            $('#s_csbzt').combobox({
                url: 'common.ashx?action=1',
                method: 'get',
                valueField: 'text',
                textField: 'text',
                panelWidth: 350,
                panelHeight: 'auto',
                editable: true
            });


            $('#s_cbmmc').combotree({
                url: 'bmzl.ashx',
                method: 'get',
                valueField: 'id',
                textField: 'text',
                panelWidth: 350,
                panelHeight: 'auto',
                editable: true
            });


            $('#s_csszy').combobox({
                url: 'sszy.ashx?action=1',
                method: 'get',
                valueField: 'id',
                textField: 'text',
                panelWidth: 350,
                panelHeight: 'auto',
                editable: true
            });

            $('#s_cscx').combobox({
                url: 'scx.ashx?action=1',
                method: 'get',
                valueField: 'id',
                textField: 'text',
                panelWidth: 350,
                panelHeight: 'auto',
                editable: true
            });

            $("#tab").datagrid({
                width: $(window).width(),
                height: $(window).height(),
                singleSelect: true, //选中一行的设置
                rownumbers: true, //行号
                url: "tjjl.ashx", //请求路径
                title: "停机记录", //标题
                pageSize: 10, //每页显示的记录条数                       
                pageList: [10, 20, 30, 40, 50], //设置每页记录条数的列表  
                //iconCls: "icon-save", //图标
                //collapsible: true, //隐藏按钮
                nowrap: false,
                fit: true,
                loadMsg: '正在加载,请稍后...',
                //冻结列
                frozenColumns: [[{ field: "chk", "checkbox": true}]],
                //列
                columns: [[
                { field: "JSON_itjzlid", title: "停机种类id", width: 100,hidden:true },
                { field: "JSON_cdh", title: "单号", width: 100 },
                { field: "JSON_dtxrq", title: "日期", width: 80, formatter: myformatter },
                { field: "JSON_csbbh", title: "设备编号", width: 100 },
                { field: "JSON_csbmc", title: "设备名称", width: 100 },
                { field: "JSON_cscx", title: "生产线", width: 100 },
                { field: "JSON_csszy", title: "专业", width: 100 },
                { field: "JSON_ctjzl", title: "停机种类", width: 100 },
                { field: "JSON_dkjrq", title: "开机时间", width: 100 },
                { field: "JSON_dtjrq", title: "停机时间", width: 100},
                { field: "JSON_cxxms", title: "现象描述", width: 100 },
                { field: "JSON_cjjfa", title: "解决方案", width: 100 },
                { field: "JSON_cyyfx", title: "原因分析", width: 100 },
                { field: "JSON_cgsdc", title: "改善对策", width: 100 },
                { field: "JSON_ctjr", title: "作业人", width: 100 },
                { field: "JSON_cfzry", title: "辅助人员", width: 80 },
                { field: "JSON_cczy", title: "操作员", width: 80 },
                { field: "JSON_cbz", title: "备注", width: 100 }
                ]],
                //传输参数
                queryParams: { "action": "query", sb: 0,state:'' },
                pagination: true,
                toolbar: "#tool",
                onDblClickRow: function () {
                    edit_dg();  //行双击调用修改函数
                }
            });
            $("#tab").datagrid('getPager').pagination({
                pageSize: 10, //每页显示的记录条数                       
                pageList: [10, 20, 30, 40, 50], //设置每页记录条数的列表                           
                beforePageText: '第', //页数文本框前显示的汉字                           
                afterPageText: '页    共 {pages} 页',
                displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录'

            });

            $("#tab_device").treegrid({
                width: 825,
                height: 425,
                singleSelect: true, //选中一行的设置
                rownumbers: true, //行号
                url: "sbzl.ashx", //请求路径
                title: "设备资料", //标题
                pageSize: 10, //每页显示的记录条数                       
                pageList: [10, 20, 30, 40, 50], //设置每页记录条数的列表  
                nowrap: false,
                //iconCls: "icon-save", //图标
                //collapsible: true, //隐藏按钮
                loadMsg: '正在加载,请稍后...',
                //冻结列
                frozenColumns: [[{ field: "chk", "checkbox": true}]],
                //列
                columns: [[
                { field: "csbfl", title: "设备分类", width: 80 },
                { field: "csbbh", title: "设备编号", width: 150 },
                { field: "csbmc", title: "设备名称", width: 150 },
                { field: "csbsbh", title: "RFID码", width: 100 },
                { field: "cscx", title: "生产线", width: 100 },
                { field: "csbzt", title: "设备状态", width: 100 },
                { field: "csbdj", title: "设备等级", width: 100 },
                { field: "cbmmc", title: "部门", width: 100 },
                { field: "csszy", title: "所属专业", width: 100 },
                { field: "csdwz", title: "上端位置", width: 100 },
                { field: "csbxh", title: "设备型号", width: 100 },
                { field: "cjscs", title: "技术参数", width: 100 },
                { field: "csccj", title: "生产厂家", width: 100 },
                { field: "izjsl", title: "装机数量", width: 100 },
                { field: "cazdd", title: "安装地点", width: 100 },
                { field: "dtyrq", title: "投用日期", width: 100, formatter: myformatter },
                { field: "cbz", title: "备注", width: 100 }
                ]],
                //传输参数
                queryParams: { "action": "query" },
                pagination: true,
                toolbar: "#tool_device"
            });
            $("#tab_device").treegrid('getPager').pagination({
                pageSize: 10, //每页显示的记录条数                       
                pageList: [10, 20, 30, 40, 50], //设置每页记录条数的列表                           
                beforePageText: '第', //页数文本框前显示的汉字                           
                afterPageText: '页    共 {pages} 页',
                displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录'
            });

            $("#tab_person").datagrid({
                width: 825,
                height: 425,
                singleSelect: true, //选中一行的设置
                rownumbers: true, //行号
                url: "ygzl.ashx", //请求路径
                pageSize: 10, //每页显示的记录条数                       
                pageList: [10, 20, 30, 40, 50], //设置每页记录条数的列表  
                //title: "员工资料", //标题
                //iconCls: "icon-save", //图标
                //collapsible: true, //隐藏按钮
                loadMsg: '正在加载,请稍后...',
                nowrap: false,
                //冻结列
                frozenColumns: [[{ field: "chk", "checkbox": true}]],
                //
                columns: [[
                { field: "JSON_ibmid", title: "部门id", hidden: "true" },
                { field: "JSON_izwid", title: "职位id", hidden: "true" },
                { field: "JSON_cygbh", title: "员工编号", width: 80 },
                { field: "JSON_cygxm", title: "员工姓名", width: 100 },
                { field: "JSON_cdlmm", title: "登陆密码", width: 100, hidden: "true" },
                { field: "JSON_cbmmc", title: "部门名称", width: 100 },
                { field: "JSON_czw", title: "职位", width: 100 },
                { field: "JSON_cxb", title: "性别", width: 100 },
                { field: "JSON_cnl", title: "年龄", width: 100 },
                { field: "JSON_drzsj", title: "入职时间", width: 100, formatter: myformatter },
                { field: "JSON_cbyyx", title: "毕业院校", width: 100 },
                { field: "JSON_czy", title: "专业", width: 100 },
                { field: "JSON_csfzh", title: "身份证号", width: 100 },
                { field: "JSON_clxdh", title: "联系电话", width: 100 },
                { field: "JSON_cjjlxr", title: "紧急联系人", width: 100 },
                { field: "JSON_cjjlxrdh", title: "紧急联系人电话", width: 100 },
                { field: "JSON_cczyf", title: "操作员否", width: 100 },
                { field: "JSON_cwxh", title: "微信号", width: 100 },
                { field: "JSON_czt", title: "状态", width: 80 },
                { field: "JSON_cbz", title: "备注", width: 100 }
                ]],
                //传输参数
                queryParams: { "action": "query" },
                pagination: true,
                toolbar: "#tool_person"
            });
            $("#tab_person").datagrid('getPager').pagination({
                pageSize: 10, //每页显示的记录条数                       
                pageList: [10, 20, 30, 40, 50], //设置每页记录条数的列表                           
                beforePageText: '第', //页数文本框前显示的汉字                           
                afterPageText: '页    共 {pages} 页',
                displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录'

            });

            $("#tab_per").datagrid({
                width: 825,
                height: 425,
                singleSelect: false, //选中一行的设置
                rownumbers: true, //行号
                url: "ygzl.ashx", //请求路径
                nowrap: false,
                pageSize: 10, //每页显示的记录条数                       
                pageList: [10, 20, 30, 40, 50], //设置每页记录条数的列表  
                //title: "员工资料", //标题
                //iconCls: "icon-save", //图标
                //collapsible: true, //隐藏按钮
                loadMsg: '正在加载,请稍后...',
                //冻结列
                frozenColumns: [[{ field: "chk", "checkbox": true}]],
                //
                columns: [[
                { field: "JSON_ibmid", title: "部门id", hidden: "true" },
                { field: "JSON_izwid", title: "职位id", hidden: "true" },
                { field: "JSON_cygbh", title: "员工编号", width: 80 },
                { field: "JSON_cygxm", title: "员工姓名", width: 100 },
                { field: "JSON_cdlmm", title: "登陆密码", width: 100, hidden: "true" },
                { field: "JSON_cbmmc", title: "部门名称", width: 100 },
                { field: "JSON_czw", title: "职位", width: 100 },
                { field: "JSON_cxb", title: "性别", width: 100 },
                { field: "JSON_cnl", title: "年龄", width: 100 },
                { field: "JSON_drzsj", title: "入职时间", width: 100, formatter: myformatter },
                { field: "JSON_cbyyx", title: "毕业院校", width: 100 },
                { field: "JSON_czy", title: "专业", width: 100 },
                { field: "JSON_csfzh", title: "身份证号", width: 100 },
                { field: "JSON_clxdh", title: "联系电话", width: 100 },
                { field: "JSON_cjjlxr", title: "紧急联系人", width: 100 },
                { field: "JSON_cjjlxrdh", title: "紧急联系人电话", width: 100 },
                { field: "JSON_cczyf", title: "操作员否", width: 100 },
                { field: "JSON_cwxh", title: "微信号", width: 100 },
                { field: "JSON_czt", title: "状态", width: 80 },
                { field: "JSON_cbz", title: "备注", width: 100 }
                ]],
                //传输参数
                queryParams: { "action": "query" },
                pagination: true,
                toolbar: "#tool_per"
            });
            $("#tab_per").datagrid('getPager').pagination({
                pageSize: 10, //每页显示的记录条数                       
                pageList: [10, 20, 30, 40, 50], //设置每页记录条数的列表                           
                beforePageText: '第', //页数文本框前显示的汉字                           
                afterPageText: '页    共 {pages} 页',
                displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录'

            });


            $("#ipt_search3").searchbox({
                width: 200,
                iconCls: 'icon-save',
                searcher: function (val, name) {
                    $('#tab_device').treegrid('options').queryParams.search_type = name;
                    $('#tab_device').treegrid('options').queryParams.search_value = val;
                    $('#tab_device').treegrid('reload');
                },
                prompt: '请输入要查询的内容'
            });

            $("#ipt_search4").searchbox({
                width: 200,
                iconCls: 'icon-save',
                searcher: function (val, name) {
                    $('#tab_person').treegrid('options').queryParams.search_type = name;
                    $('#tab_person').treegrid('options').queryParams.search_value = val;
                    $('#tab_person').treegrid('reload');
                },
                prompt: '请输入要查询的内容'
            });

            $("#ipt_search6").searchbox({
                width: 200,
                iconCls: 'icon-save',
                searcher: function (val, name) {
                    $('#tab_per').datagrid('options').queryParams.search_type = name;
                    $('#tab_per').datagrid('options').queryParams.search_value = val;
                    $('#tab_per').datagrid('reload');
                },
                prompt: '请输入要查询的内容'
            });


            //设备资料关联记录
            var ssurl = window.location.href;
            var slen = ssurl.substr(0, ssurl.indexOf("&")).length;  //第一个&出现的位置
            if (slen > 0) {
                var s = get_url(ssurl);
                var len = s.substr(0, s.indexOf("&")).length;  //第一个&出现的位置
                var sstr = s.substr(len + 1, s.length - len);

                if (sstr == "" || sstr == null || sstr == undefined || sstr.length == 0) {
                    searchVal();
                }
                else {
                    $('#tab').datagrid({ url: 'tjjl.ashx', queryParams: { "action": "query", sb: sstr, state: "s"} });
                }
            }
            else {
                searchVal();
                //$('#tab').datagrid({ url: 'tjjl.ashx', queryParams: { "action": "query", state: "s"} });
            }
        })
        /////////////////////////删除/////////////////
        function delete_dg() {
            //获取url
            var surl = get_url();
            $.post("qx_load.ashx", { "action": "del", data: surl }, function (data) {
                if (data == "del") {
                    $.messager.alert("提示", "您没有操作此功能的权限，请与系统管理员联系！");
                    return;
                }

                var selected = $("#tab").datagrid('getSelected');
                if (selected != null) {
                    $.messager.confirm('提示', '是否确定要删除？', function (y) {
                        if (y) {
                            var v = "";
                            var checked = $("#tab").datagrid('getChecked');
                            $.each(checked, function (i, j) {
                                v += j.JSON_id + ",";
                            })
                            v = v.substring(0, v.length - 1);
                            $.post("tjjl.ashx", { "action": "del", id: v }, function (data) {
                                $.messager.alert('提示', data);
                                $("#tab").datagrid('reload');
                            });
                        }
                    })
                } else {
                    $.messager.alert('提示', '您还没有选中一行数，请选中在删除！');
                }
            });
        }
        /////////////////////添加///////////////////
        function add_dg() {
            //获取url
            var surl = get_url();
            $.post("qx_load.ashx", { "action": "add", data: surl }, function (data) {
                if (data == "add") {
                    $.messager.alert("提示", "您没有操作此功能的权限，请与系统管理员联系！");
                    return;
                }

                //表单清空
                $("#fm_dg")[0].reset();
                //显示
                $("#dd_dg").show();

                var myDate = new Date();
                var parm = myDate.toLocaleDateString();
                parm = parm + "&TJ"
                var pp = decodeURIComponent(parm, true);
                //自动生成工单号
                $.post("scgdh.ashx", { data: pp }, function (data) {
                    $('#cdh').val(data);
                });

                //获取操作员
                $.post("getSession.ashx", function (data) {
                    $('#cczy').val(data);
                });

                //使用服务器函数返回日期
                $.post("getDate.ashx", { data: myDate.toLocaleDateString() }, function (data) {
                    $('#dtxrq').datebox('setValue', data);

                });

                var curtime = getCurTime();

                //使用服务器函数返回日期
                $.post("getDate.ashx", { data: curtime }, function (data) {
                    $('#dkjrq').datetimebox('setValue', data);
                    $('#dtjrq').datetimebox('setValue', data);
                });

                

                //以窗体的形式展示
                $("#dd_dg").dialog({
                    title: "添加停机记录", //标题
                    iconCls: "icon-add", //图标
                    width: 600, //窗体的宽度
                    height: 450, //窗体的高度
                    modal: true, //遮罩层
                    //按钮集合
                    buttons: [
            {
                text: "保存", //添加按钮的文本值
                iconCls: "icon-ok", //添加按钮的图标
                handler: function () {
                    //将数据序列化
                    var parm = $("#fm_dg").serialize();
                    //中文格式转换
                    var pp = decodeURIComponent(parm, true);
                    //post异步提交
                    $.post("tjjl.ashx", { "action": "add", data: pp }, function (data) {
                        if (data == "1") {
                            $.messager.alert('提示', "单号不允许为空！");
                            return;
                        }

                        if (data == "2") {
                            $.messager.alert('提示', "单号已存在，请重新输入！");
                            return;
                        }

                        if (data == "3") {
                            $.messager.alert('提示', "设备不允许为空！");
                            return;
                        }

                        if (data == "4") {
                            $.messager.alert('提示', "该设备不存在，请重新输入！");
                            return;
                        }

//                        if (data == "9") {
//                            $.messager.alert('提示', "作业人不允许为空，请重新选择！");
//                            return;
//                        }

                        $.messager.alert('提示', data);
                        //重新加载datagrid
                        $("#tab").datagrid('reload');
                        //关闭
                        $("#dd_dg").window('close');
                    });
                }
            },
              {
                  text: "取消",
                  iconCls: "icon-cancel",
                  handler: function () {
                      $("#dd_dg").window("close");
                  }
              }
            ]
                });
            });
        }
        //////////////////修改//////////////////
        function edit_dg() {
            //获取url
            var surl = get_url();
            $.post("qx_load.ashx", { "action": "edit", data: surl }, function (data) {
                if (data == "edit") {
                    $.messager.alert("提示", "您没有操作此功能的权限，请与系统管理员联系！");
                    return;
                }

                //选中一行，获取这一行的属性的值
                var selected = $("#tab").datagrid('getSelected');
                //判断是否选中
                if (selected != null) {
                    $('#dtxrq').datebox('setValue', myformatter(selected.JSON_dtxrq));
                    $("#ctjr").val(selected.JSON_ctjr);
                    $('#ctjzl').combotree("setValue", selected.JSON_itjzlid);
                    $('#dkjrq').datetimebox('setValue', selected.JSON_dkjrq);
                    $('#dtjrq').datetimebox('setValue',selected.JSON_dtjrq);

                    $("#id").val(selected.JSON_id);
                    $("#cdh").val(selected.JSON_cdh);
                    $('#csbbh').val(selected.JSON_csbbh);
                    $("#csbmc").val(selected.JSON_csbmc);
                    $('#cscx').val(selected.JSON_cscx);
                    $('#csszy').val(selected.JSON_csszy);
                    $("#cxxms").val(selected.JSON_cxxms);
                    $("#cjjfa").val(selected.JSON_cjjfa);
                    $("#cyyfx").val(selected.JSON_cyyfx);
                    $("#cgsdc").val(selected.JSON_cgsdc);
                    $("#cfzry").val(selected.JSON_cfzry);
                    $("#cczy").val(selected.JSON_cczy);
                    $("#cbz").val(selected.JSON_cbz);

                    $("#dd_dg").show(); //显示修改窗体
                    $("#dd_dg").dialog({
                        title: "编辑停机记录",
                        iconCls: "icon-edit",
                        modal: true, //遮罩层
                        width: 600,
                        height:450,
                        buttons: [
                  {
                      text: "保存",
                      iconCls: "icon-edit",
                      handler: function () {
                          var parm = $("#fm_dg").serialize();
                          var pp = decodeURIComponent(parm, true);
                          $.post("tjjl.ashx", { "action": "edit", data: pp }, function (data) {
                              if (data == "1") {
                                  $.messager.alert('提示', "单号不允许为空！");
                                  return;
                              }

                              if (data == "2") {
                                  $.messager.alert('提示', "单号已存在，请重新输入！");
                                  return;
                              }

                              if (data == "3") {
                                  $.messager.alert('提示', "设备不允许为空！");
                                  return;
                              }

                              if (data == "4") {
                                  $.messager.alert('提示', "该设备不存在，请重新输入！");
                                  return;
                              }

//                              if (data == "9") {
//                                  $.messager.alert('提示', "作业人不允许为空，请重新选择！");
//                                  return;
//                              }

                              $.messager.alert('提示', data);
                              $("#tab").datagrid("reload");
                              $("#dd_dg").window("close");
                          });
                      }

                  },
                    {
                        text: "取消",
                        iconCls: "icon-cancel",
                        handler: function () {
                            $("#dd_dg").window('close');
                        }
                    }
                  ]


                    });
                } else {
                    $.messager.alert('提示', '请选中一行在进行编辑');
                }
            });
        }


        function sec() {
            //设备编号
            var csbbh = document.getElementById("csbbh").value;

            if (csbbh == "" || csbbh == null) {
                $.messager.alert("提示", "设备编号不允许为空，请输入！");
                return;
            }

            var pp = decodeURIComponent(csbbh, true);

            $.post("sb_load.ashx", { data: pp }, function (data) {
                if (data == "") {
                    $.messager.alert("提示", "无法查找该设备，请重新输入！");
                    return;
                }

                var len = data.substr(0, data.indexOf("&")).length;  //&出现的位置
                var llen = data.substr(0, data.indexOf(",")).length;  //,出现的位置
                var sbmc = data.substr(0, len);
                var scx = data.substr(len + 1, llen - len - 1);
                var csszy = data.substr(llen + 1, data.length - llen);
                $("#csbmc").val(sbmc);
                $("#cscx").val(scx);
                $("#czy").val(csszy);
            });
        }
    </script>
</head>
<body style="width:100%;height:100%;margin:0;padding:0;overflow:hidden">
<table id="tab">
</table>
<div id="tool">
       <table border="0" cellspacing="0" cellpadding="0" width="100%">
       	<tr>
       		<td style=" padding-left:2px">
                <a href="#" class="easyui-linkbutton" id="id_add" iconcls="icon-add"  plain="true" onclick="add_dg();" >添加</a>
                <a href="#" class="easyui-linkbutton" id="id_edit" iconCls="icon-edit"  plain="true" onclick="edit_dg();">修改</a>
                <a href="#" class="easyui-linkbutton" id="id_cancel" onclick="delete_dg();"  iconcls="icon-cancel" plain="true">删除</a>
            </td>
        </tr>
        <tr>
        <td style="text-align: left; ">
            <div id="Div1">
                日期: <input id="dqsrq" name="dqsrq" class="easyui-datebox"  style="width:100px;" editable="false"/>
			    至<input id="djzrq" name="djzrq" class="easyui-datebox"   style="width:100px;"  editable="false"/> 
                <select style="width:135px;" id="sel_key" name="sel_key" class="easyui-combobox" >
                    <option value="单号">单号</option>
                    <option value="设备编号">设备编号</option>
                    <option value="设备名称">设备名称</option>
                    <option value="生产线">生产线</option>
                    <option value="停机种类">停机种类</option>
                    <option value="现象描述">现象描述</option>
                    <option value="解决方案">解决方案</option>
                    <option value="原因分析">原因分析</option>
                    <option value="改善对策">改善对策</option>
                    <option value="作业人">作业人</option>
                    <option value="辅助人员">辅助人员</option>
                    <option value="制单人">制单人</option>
                    <option value="备注">备注</option>
                  </select>
                  <input id="cmemo" name="cmemo" class="easyui-validatebox"  style="width:150px;"/>
                <a href="#" class="easyui-linkbutton"  iconCls="icon-search"  onclick="searchVal();">查询</a>
            </div>
            </td>     
       	</tr>
       </table>
    </div>
    </br>
    <div id="tool_device">
       <table border="0" cellspacing="0" cellpadding="0" width="100%">
       	<tr>
            <td style=" padding-left:2px">
                <a href="#" class="easyui-linkbutton" id="id_search" onclick="search_dg();"  iconcls="icon-search" plain="true">高级查询</a>
            </td>
            <td style="text-align: right; padding-right: 15px">
                    <input id="ipt_search3" menu="#search_menu3" />
                    <div id="search_menu3" style="width:120px">
                        <div name="csbfl">
                            设备分类</div>
                        <div name="csbbh">
                            设备编号</div>
                        <div name="csbmc">
                            设备名称</div>
                        <div name="csbsbh">
                            RFID码</div>
                        <div name="cscx">
                            生产线</div>
                        <div name="csszy">
                            所属专业</div>
                        <div name="csdwz">
                            上端位置</div>
                        <div name="csbxh">
                            设备型号</div>
                        <div name="cjscs">
                            技术参数</div>
                        <div name="csccj">
                            生产厂家</div>
                        <div name="izjsl">
                            装机数量</div>
                        <div name="cazdd">
                            安装地点</div>
                        <div name="csbdj">
                            设备等级</div>
                        <div name="csbzt">
                            设备状态</div>
                        <div name="cbz">
                            备注</div>
                    </div>
                </td>
       	</tr>
       </table>
    </div>
    <br />
    <div id="tool_person">
       <table border="0" cellspacing="0" cellpadding="0" width="100%">
       	<tr>
            <td style="text-align: right; padding-right: 15px">
                    <input id="ipt_search4" menu="#search_menu4" />
                    <div id="search_menu4" style="width:120px">
                        <div name="cygbh">
                            员工编号</div>
                        <div name="cygxm">
                            员工姓名</div>
                        <div name="cbmmc">
                            部门名称</div>
                        <div name="czw">
                            职位</div>
                        <div name="cxb">
                            性别</div>
                          <div name="cnl">
                            年龄</div>
                        <div name="drzsj">
                            入职时间</div>
                        <div name="cbyyx">
                            毕业院校</div>
                        <div name="czy">
                            专业</div>
                        <div name="csfzh">
                            身份证号</div>
                        <div name="clxdh">
                            联系电话</div>
                        <div name="cjjlxr">
                            紧急联系人</div>
                        <div name="cjjlxrdh">
                            紧急联系人电话</div>
                        <div name="cczyf">
                            操作员否</div>
                        <div name="cwxh">
                            微信号</div>
                        <div name="czt">
                            状态</div>
                        <div name="cbz">
                            备注</div>
                    </div>
                </td>
       	</tr>
       </table>
    </div>
     <br />
    <div id="tool_per">
       <table border="0" cellspacing="0" cellpadding="0" width="100%">
       	<tr>
            <td style="text-align: right; padding-right: 15px">
                    <input id="ipt_search6" menu="#search_menu6" />
                    <div id="search_menu6" style="width:120px">
                        <div name="cygbh">
                            员工编号</div>
                        <div name="cygxm">
                            员工姓名</div>
                        <div name="cbmmc">
                            部门名称</div>
                        <div name="czw">
                            职位</div>
                        <div name="cxb">
                            性别</div>
                          <div name="cnl">
                            年龄</div>
                        <div name="drzsj">
                            入职时间</div>
                        <div name="cbyyx">
                            毕业院校</div>
                        <div name="czy">
                            专业</div>
                        <div name="csfzh">
                            身份证号</div>
                        <div name="clxdh">
                            联系电话</div>
                        <div name="cjjlxr">
                            紧急联系人</div>
                        <div name="cjjlxrdh">
                            紧急联系人电话</div>
                        <div name="cczyf">
                            操作员否</div>
                        <div name="cwxh">
                            微信号</div>
                        <div name="czt">
                            状态</div>
                        <div name="cbz">
                            备注</div>
                    </div>
                </td>
       	</tr>
       </table>
    </div>
    <br />
   <div id="dd_dg" style=" display:none">
        <form id="fm_dg">
        <input type="hidden" id="id" name="id"/>
        <table border="0">
            <tr>
            <td width="80" height="31"><div align="right">单号:</div></td>
            <td width="200"><input id="cdh" style="width:140px;" name="cdh" class="easyui-validatebox"  required="true" missingMessage="请输入订单号" readonly /></td>
            <td width="80" height="31"><div align="right">日期:</div></td>
            <td><input style="width:145px;" id="dtxrq" name="dtxrq" class="easyui-datebox"   required="true" missingMessage="请选择填写日期" /></td>
          </tr>
          <tr>
          <td width="63" height="31"><div align="right">设备编号:</div></td>
          <td width="200"><input style="width:140px;" type="text" id="csbbh" name="csbbh" class="easyui-validatebox"   onkeyup="if (event.keyCode==13) {sec();}" readonly/>
            <a href="#" class="easyui-linkbutton" id="search" iconcls="icon-search"  plain="true" onclick="selectDevice();" ></a></td>
          <td width="84" height="31"><div align="right">设备名称:</div></td>
        <td width="200"><input style="width:140px;" type="text" id="csbmc" name="csbmc" class="easyui-validatebox" readonly /></td>
          </tr>
          <tr>
            <td height="30"><div align="right">生产线:</div></td>
            <td><input style="width:140px;" type="text"  id="cscx" name="cscx" class="easyui-validatebox"   readonly /></td>
            
             <td width="61" height="30"><div align="right">专业:</div></td>
            <td width="200"><input style="width:140px;" type="text" id="csszy" name="csszy" class="easyui-validatebox" readonly /></td>
          </tr>
          <tr>
            <td height="41"><div align="right">开机时间:</div></td>
            <td><input id="dkjrq" style="width:145px;" name="dkjrq" class="easyui-datetimebox"    required="true" missingMessage="请输入开机日期"  /></td>

            <td height="41"><div align="right">停机时间:</div></td>
            <td><input id="dtjrq" style="width:145px;" name="dtjrq" class="easyui-datetimebox"    required="true" missingMessage="请输入停机日期"  /></td>
            </tr>
           <tr>
           <td height="41"><div align="right">停机种类:</div></td>
            <td><input id="ctjzl" style="width:145px;" name="ctjzl" class="easyui-combobox"  required="true" missingMessage="请选择停机种类" /></td>

            <td height="41"><div align="right">现象描述:</div></td>
            <td><input id="cxxms" style="width:140px;" name="cxxms" rows="5" class="easyui-validatebox" 
            onkeyup="value=value.replace(' ','')" onkeypress="processSpelChar();"></td>

          </tr>
          <tr>
            <td height="41"><div align="right">解决方案:</div></td>
            <td><input id="cjjfa" style="width:140px;" name="cjjfa" rows="5" class="easyui-validatebox" 
            onkeyup="value=value.replace(' ','')" onkeypress="processSpelChar();" ></td>

            <td height="41"><div align="right">原因分析:</div></td>
            <td><input id="cyyfx" style="width:140px;" name="cyyfx" rows="5" class="easyui-validatebox" 
            onkeyup="value=value.replace(' ','')" onkeypress="processSpelChar();" ></td>
          </tr>
          <tr>
          <td height="41"><div align="right">改善对策:</div></td>
            <td><input id="cgsdc" style="width:140px;" name="cgsdc"class="easyui-validatebox" 
            onkeyup="value=value.replace(' ','')" onkeypress="processSpelChar();" ></td>
            <td height="41"><div align="right">作业人:</div></td>
            <td><input id="ctjr" style="width:140px;" name="ctjr"class="easyui-validatebox" readonly>
             <a href="#" class="easyui-linkbutton" id="searchPerson" iconcls="icon-search"  plain="true" onclick="selectPerson();" ></a></td>
          </tr>
           <tr>
          <td height="41"><div align="right">辅助人员:</div></td>
            <td colspan="3"><input style="width:430px;" id="cfzry" name="cfzry" class="easyui-validatebox"  
            onkeyup="value=value.replace(' ','')" onkeypress="processSpelChar();"/>
             <a href="#" class="easyui-linkbutton" id="selperson" iconcls="icon-search"  plain="true" onclick="selPerson();" ></a></td>
          </tr>
          <td height="41"><div align="right">制单人:</div></td>
            <td colspan="3"><input style="width:430px;" id="cczy" name="cczy" class="easyui-validatebox"   readonly/></td>
          </tr>
          <tr>
          <td height="41"><div align="right">备注:</div></td>
            <td colspan="3"><input style="width:430px;" id="cbz" name="cbz" class="easyui-validatebox"  
            onkeyup="value=value.replace(' ','')" onkeypress="processSpelChar();"/></td>
          </tr>
</table>
        </form>
    </div>

    
<div id="div2" style=" display:none">
        <form id="form2">
    <div id="sel" align="center">
    <table id="tab_device" class="easyui-treegrid"
			data-options="
				method: 'get',
				rownumbers: true,
				idField: 'id',
				treeField: 'csbmc',
                loadFilter: pagerFilter
			">
</table>
</div>
</form>
</div>


<div id="div4" style=" display:none">
        <form id="form4">
    <div id="div_person" align="center">
    <table id="tab_person">
</table>
</div>
</form>
</div>

<div id="div5" style=" display:none">
        <form id="form5">
    <div id="div_per" align="center">
    <table id="tab_per">
</table>
</div>
</form>
</div>



<div id="div_search" align="center" style="display:none">
        <form id="fm_search">
        <table border="0">
          <tr>
            <td width="109" height="30"><div align="right">设备编号:</div></td>
            <td width="192"><input style="width:130px" type="text" id="s_csbbh" name="s_csbbh" class="easyui-validatebox"  /></td>
          
            <td height="30"><div align="right">设备名称:</div></td>
            <td><input type="text" style="width:130px" id="s_csbmc" name="s_csbmc" class="easyui-validatebox" /></td>
            </tr>
          <tr>
            <td height="30"><div align="right">RFID码:</div></td>
            <td><input type="text" style="width:130px" id="s_csbsbh" name="s_csbsbh" class="easyui-validatebox"  /></td>

            <td height="30"><div align="right">所属专业:</div></td>
            <td><input id="s_csszy" style="width:135px" name="s_csszy" class="easyui-combobox"></td>
          </tr>
          <tr>
            <td height="30"><div align="right">生产线:</div></td>
            <td><input id="s_cscx" style="width:135px" name="s_cscx" class="easyui-combobox"/></td>

            <td height="30"><div align="right">设备型号:</div></td>
            <td><input type="text" style="width:130px" id="s_csbxh" name="s_csbxh" class="easyui-validatebox" /></td>

          </tr>
          <tr>
            <td height="30"><div align="right">上端位置:</div></td>
            <td><input type="text" style="width:130px" id="s_csdwz" name="s_csdwz" class="easyui-validatebox" /></td>


            <td height="30"><div align="right">技术参数:</div></td>
            <td><input type="text" style="width:130px" id="s_cjscs" name="s_cjscs" class="easyui-validatebox"/></td>
           </tr>
           <tr>
            <td width="109" height="30"><div align="right">设备状态:</div></td>
            <td width="195"><input style="width:135px;" id="s_csbzt" name="s_csbzt" class="easyui-combobox" /></td>

            <td width="109" height="0"><div align="right">设备等级:</div></td>
            <td width="195"><input style="width:135px;" id="s_csbdj" name="s_csbdj" class="easyui-combobox" /></td>
          </tr>
          <tr>
            <td height="30"><div align="right">生产厂家:</div></td> 
            <td><input type="text" style="width:130px" id="s_csccj" name="s_csccj" class="easyui-validatebox" /></td>

            <td height="30"><div align="right">装机数量:</div></td>
            <td><input type="text" style="width:130px" id="s_izjsl" name="s_izjsl" class="easyui-numberbox" style="text-align:right"/></td>
          </tr>
          <tr>
            
            <td height="30"><div align="right">安装地点:</div></td>
            <td><input type="text" style="width:130px" id="s_cazdd" name="s_cazdd" class="easyui-validatebox"  /></td>

            <td height="30"><div align="right">备注:</div></td>
            <td ><input type="text" style="width:130px" id="s_cbz" name="s_cbz" class="easyui-validatebox"/></td>
          </tr>

        </table>
        </form>
	</div>
</body>
</html>
